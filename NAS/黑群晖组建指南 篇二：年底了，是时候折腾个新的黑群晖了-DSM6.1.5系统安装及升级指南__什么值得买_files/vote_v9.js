$(function(){var vote={htmlTemplate:'<div class="vote-wrapper">'+"        {{#form_name}}"+'            <h2 class="vote-info {{#is_death_date}}vote-timeover{{/is_death_date}}">'+"                投票{{^is_show_before}}"+'                {{#form_name.is_death_date}}已结束{{/form_name.is_death_date}} {{#form_name.form_vote_num}}<span class="vote-status">'+"                {{#showResult}}共有{{/showResult}}"+"                {{^showResult}}已有{{/showResult}}"+'                <span class="red">{{form_name.form_vote_num}}</span>人投票</span>{{/form_name.form_vote_num}}'+"                {{/is_show_before}}{{^is_show_date}}{{#show_date}}"+'                <span class="time show_date">揭晓时间：{{show_date}}</span>{{/show_date}}{{/is_show_date}}'+'                <span class="time">截止时间：{{death_date}}</span>'+"            </h2>"+"        {{/form_name}}"+'        <div class="vote-content {{#form_name.is_death_date}}vote-timeover{{/form_name.is_death_date}}">'+'            <h2 class="vote-title">{{form_name.title}}</h2>'+"            <ol>"+"            {{#form_type}}"+'                <li class="vote-qa">'+'                    <h3 class="vote-question"><span class="num">{{index}}.</span><span class="que-txt">{{name}}</span><span class="require">*</span></h3>'+'                    <ul class="vote-answer clearfix">'+"                        {{^form_name.showResult}}"+"                        {{#values}}"+'                        <li class="vote-item"><label><input type="{{types}}" name="{{id}}"><span class="icon {{types}}"></span><span class="J_value">{{.}}</span></label></li>'+"                        {{/values}}"+"                        {{/form_name.showResult}}"+"                        {{#form_name.showResult}}"+"                        {{#form_name.is_show_before}}"+"                        {{#vote_result_before}}"+'                        <li class="vote-item {{#hasSelected}} J_checked {{/hasSelected}}" ><label><span class="icon {{types}}"></span><span class="J_value">{{field}}</span></label></li>'+"                        {{/vote_result_before}}"+"                        {{/form_name.is_show_before}}"+"                        {{^form_name.is_show_before}}"+"                        {{#vote_result}}"+'                        <li class="vote-item vote-finish {{#hasSelected}}J_vote_selected{{/hasSelected}}">'+"                            <label>{{field}}</label>"+'                            <div class="vote-result z-clearfix">'+'                                <div class="progress-bar">'+'                                   <div class="inner" style="width:{{percent}}%"></div>'+"                                </div> "+'                                <span class="votes-percent">{{percent}}%</span>'+'                                <span class="votes-count">{{counts}}票</span>'+"                            </div>"+"                        </li>"+"                        {{/vote_result}}"+"                        {{/form_name.is_show_before}}"+"                        {{/form_name.showResult}}"+"                    </ul> "+"                    {{^form_name.showResult}}"+"                    {{#checkArr}} "+'                    <div class="error red" data-needCheck="{{needCheck}}" data-ansLen="{{ansLen}}" data-condition="{{condition}}">{{errMsg}}</div>'+"                    {{/checkArr}} "+"                    {{/form_name.showResult}}"+"                </li>"+"            {{/form_type}}"+"            </ol>"+"            {{#form_name.showResult}}"+"            {{^form_name.is_death_date}}"+'            <button class="vote-btn voted-btn" type="button">您已投票</button>'+"            {{/form_name.is_death_date}}"+"            {{/form_name.showResult}} "+"            {{^form_name.showResult}}"+"            {{^form_name.is_death_date}}"+'            <button class="vote-btn" type="button">投票</button>'+"            {{/form_name.is_death_date}}"+"            {{/form_name.showResult}}"+"            {{#form_name.is_death_date}}"+"               {{#form_name.is_show_before}}"+'               <button class="vote-button" type="button">投票</button>'+"               {{/form_name.is_show_before}}"+"            {{/form_name.is_death_date}}"+"        </div>"+"   </div>",ajaxUrl:{status:"//tools.smzdm.com/vote/biaodan_vote/index",userLogin:"//zhiyou.smzdm.com/user/info/jsonp_get_current",submitForm:'//tools.smzdm.com/vote/biaodan_vote/submit?callback="1"'},init:function(){var $voteEl=$(".smzdm-vote");var biaodanId;var $voteWrapper;var _this=this;if($voteEl.length){document.domain="smzdm.com";$.each($voteEl,function(item,index){biaodanId=$(this).attr("data-voteid");$voteWrapper=$(this);_this.getData(biaodanId,$voteWrapper)})}else{document.domain="smzdm.com";$voteEl=$("#J_vote_form");if($voteEl.length>0&&$voteEl.val()!=="0"){biaodanId=$voteEl.val();$voteWrapper=$('<div class="smzdm-vote" data-voteid="'+biaodanId+'"></vote>');$voteWrapper.appendTo($(".leftWrap article"));_this.getData(biaodanId,$voteWrapper)}else{return""}}_this.clickEvent();Mustache.escape=function(str){return str};Mustache.parse(_this.htmlTemplate)},clickEvent:function(){var _this=this;$(document).on("click",".vote-content input",function(){var hasSelectAll=false;var $voteWrapper=$(this).parents(".smzdm-vote");var $voteBtn=$voteWrapper.find(".vote-btn");var $voteAnswer=$voteWrapper.find(".vote-answer");if($(this).attr("type")==="radio"){var name=$(this).prop("name");$("input[name='"+name+"']").removeClass("J_selected");$(this).addClass("J_selected")}else{$(this).toggleClass("J_selected")}hasSelectAll=true;$.each($voteAnswer,function(index,item){var $els=$(this).find(".J_selected");if($els.length===0){hasSelectAll=false}});if(hasSelectAll){$voteBtn.addClass("vote-able")}else{$voteBtn.removeClass("vote-able")}});$(document).on("click",".vote-able",function(){var $voteWrapper=$(this).parents(".smzdm-vote");var biaodanId=$voteWrapper.attr("data-voteid");$.ajax({url:_this.ajaxUrl.userLogin,type:"post",dataType:"jsonp",jsonp:"callback",success:function(resp){if(resp.smzdm_id==0){$(".J_login_trigger").trigger("click")}else{_this.checkVoteForm(biaodanId,$voteWrapper)}},error:function(resp){alert("网络出错，请稍后再试")}})})},getData:function(biaodanId,$voteWrapper){var _this=this;console.log("biaodanId:",biaodanId);$.ajax({url:_this.ajaxUrl.status,type:"get",dataType:"jsonp",data:{biaodan_id:biaodanId},jsonp:"callback",success:function(res){if(res.error_code===0){var ajaxData=res.data;var htmlStr;var form_type=ajaxData.form_type;var form_name=ajaxData.form_name;var is_show_before;if(form_name.show_time_style===2&&!form_name.is_show_date){form_name.is_show_before=true;is_show_before=true}else{form_name.is_show_before=false;is_show_before=false}if(form_type.length>0){$.each(form_type,function(index,item){var vote_result=item.vote_result;var total_count=item.all_counts;var vote_result;var my_vote=item.my_vote;var remain=100;var errMsg;var checkArr;item.index=index+1;item.values=item.values.split(",");if(item.types==="checkbox"){item.name+="（多选）"}else if(item.types==="radio"){item.name+="（单选）"}if(vote_result.length>0){vote_result=item.vote_result;$.each(vote_result,function(idex,items){if(total_count>0){if(idex>0){items.percent=Math.round(items.counts*100/total_count);remain-=items.percent}}else{items.percent=0}items.hasSelected=false;if(my_vote.length>0){$.each(my_vote,function(a,b){if(b==items.field){items.hasSelected=true}})}});if(total_count>0){vote_result[0].percent=remain}else{vote_result[0].percent=0}}if(is_show_before){var _values=item.values;var vote_result_before=[];$.each(_values,function(idex,items){var _obj={field:items,hasSelected:false};if(my_vote.length>0){$.each(my_vote,function(a,b){if(b==_obj.field){_obj.hasSelected=true}})}vote_result_before.push(_obj)});item.vote_result_before=vote_result_before}item.write_field_num_symbol=Number(item.write_field_num_symbol);item.write_field_num=Number(item.write_field_num);switch(item.write_field_num_symbol){case 1:errMsg="此选项必须填写大于"+item.write_field_num+"项";checkArr={needCheck:true,ansLen:item.write_field_num,errMsg:errMsg,condition:1};break;case 2:errMsg="此选项必须填写大于等于"+item.write_field_num+"项";checkArr={needCheck:true,ansLen:item.write_field_num,errMsg:errMsg,condition:2};break;case 3:errMsg="此选项必须填写"+item.write_field_num+"项";checkArr={needCheck:true,ansLen:item.write_field_num,errMsg:errMsg,condition:3};break;case 4:errMsg="此选项必须填写小于"+item.write_field_num+"项";checkArr={needCheck:true,ansLen:item.write_field_num,errMsg:errMsg,condition:4};break;case 5:errMsg="此选项必须填写小于等于"+item.write_field_num+"项";checkArr={needCheck:true,ansLen:item.write_field_num,errMsg:errMsg,condition:5};break;case 6:errMsg="此选项必须填写不能等于"+item.write_field_num+"项";checkArr={needCheck:true,ansLen:item.write_field_num,errMsg:errMsg,condition:6};break;default:checkArr={needCheck:false}}item.checkArr=checkArr});if(form_type[0].my_vote.length==0&&!form_name.is_death_date){form_name.showResult=false}else{form_name.showResult=true}console.log("ajaxData:",ajaxData);htmlStr=Mustache.render(_this.htmlTemplate,ajaxData);$voteWrapper.html("");$voteWrapper.append(htmlStr)}}},error:function(res){console.log(res)}})},loadRefresh:function(_this,biaodanId,$voteWrapper,json){var error_msg=json.error_msg;switch(json.error_code){case 0:_this.getData(biaodanId,$voteWrapper);popUp("","#pop-status-success","投票成功，感谢您的参与");break;case 1:case 2:case 3:_this.getData(biaodanId,$voteWrapper);popUp("","#pop-status-fail",error_msg);break;case 4:case 5:popUp("","#pop-status-fail",error_msg);case 6:$(".J_login_trigger").trigger("click");break}},crossDominPost:function(url,data,fn,biaodanId,$voteWrapper){var _this=this;var form=document.createElement("form");var input_biaodan=document.createElement("input");form.id=form.name="postForm";input_biaodan.type="hidden";input_biaodan.name="biaodan_id";input_biaodan.value=data.biaodan_id;form.appendChild(input_biaodan);$.each(data.field,function(index,item){$.each(item,function(key,value){var input=document.createElement("input");input.type="hidden";input.name="field["+index+"]"+key;input.value=value;form.appendChild(input)})});var iframe=document.createElement("iframe");iframe.setAttribute("name","postIFrame");iframe.id="postIFrame";iframe.width=1;iframe.height=1;iframe.style.display="none";document.body.appendChild(iframe);document.body.appendChild(form);form.action=url;form.target=iframe.name;form.method="post";form.submit();if(iframe.attachEvent){iframe.attachEvent("onload",_loadFn)}else{iframe.onload=_loadFn}iframe.state=0;function _loadFn(){if(iframe.state===1){iframe.onload=null;document.body.removeChild(iframe)}else if(iframe.state===0){iframe.state=1;var data="";try{data=iframe.contentWindow.name;console.log(iframe.contentWindow);console.log("12"+data)}catch(e){console.log(e)}var json=data;try{json=JSON.parse(data)}catch(e){}console.log("数据已经提交，开始走回调");_callback(json);console.log(iframe.contentWindow.name);iframe.contentWindow.location="about:blank"}}function _callback(json){if(fn&&typeof fn==="function"){console.log("走到这里了",_this);fn(_this,biaodanId,$voteWrapper,json)}}return false},checkVoteForm:function(biaodanId,$voteWrapper){var _this=this;var selectedArr=[];var checkPass=true;var ajaxData={};var $voteQa=$voteWrapper.find(".vote-qa");$voteQa.each(function(index,item){var $selectedElsLen;var selectedObj={};var field_value;var field_id;var field_type;var $errorTips=$(this).find(".error");var ansLen=Number($errorTips.attr("data-ansLen"));var condition=Number($errorTips.attr("data-condition"));var needCheck=$errorTips.attr("data-needcheck")==="true"?true:false;var showError=false;$selectedEls=$(this).find(".J_selected");$selectedEls.each(function(index,item){field_value=$(this).siblings(".J_value").text();field_id=Number($(this).attr("name"));selectedObj["[field_id]"]=field_id;field_type=$(this).attr("type");if(field_type=="checkbox"){selectedObj["[field_value]["+index+"]"]=field_value}else{selectedObj["[field_value]"]=field_value}});selectedArr.push(selectedObj);if(needCheck){$selectedElsLen=$selectedEls.length;if(condition){if(condition===1&&$selectedElsLen<=ansLen||condition===2&&$selectedElsLen<ansLen||condition===3&&$selectedElsLen!=ansLen||condition===4&&$selectedElsLen>=ansLen||condition===5&&$selectedElsLen>ansLen||condition===6&&$selectedElsLen==ansLen){checkPass=false;showError=true}}}if(showError){$errorTips.show()}else{$errorTips.hide()}});ajaxData={field:selectedArr,biaodan_id:biaodanId};if(checkPass){_this.crossDominPost(_this.ajaxUrl.submitForm,ajaxData,_this.loadRefresh,biaodanId,$voteWrapper)}}};vote.init()});